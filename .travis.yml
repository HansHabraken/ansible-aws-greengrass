language: python

sudo: required

services:
  - docker

before_install:
  - cp inventory.local inventory
  - cp extra_vars.yml.ci extra_vars.yml
  - sed -ri "s/AWS_ACCESS_KEY/$AWS_ACCESS_KEY/" extra_vars.yml
  - sed -ri "s/AWS_SECRET_KEY/$AWS_SECRET_KEY/" extra_vars.yml
  - pip install ansible
  - docker build -t vmware/ansible-aws-greengrass .

script:
  - >
    ansible-playbook site.yml -i inventory --extra-vars "@extra_vars.yml"
    --check --skip-tag greengrass-core
  - >
    [ $AWS_ACCESS_KEY ] && ansible-playbook dev.yml -i inventory
    --extra-vars "@extra_vars.yml"
  - cd roles/greengrass-init/tests
  - [ $AWS_ACCESS_KEY ] && ansible-playbook test.yml -i inventory
  - >
    [ $AWS_ACCESS_KEY ] &&
    docker run -it --rm vmware/ansible-aws-greengrass site.yml
    -i inventory -v --extra-vars "@extra_vars.yml"
